name: "Merge Associated PR on Issue Completion (using gh CLI)"

on:
  issues:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  merge-associated-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Determine Associated PR Number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          BRANCH_NAME="submission/issue-${ISSUE_NUMBER}"
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' || echo "")

          if [[ -n "$PR_NUMBER" ]]; then
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          else
            echo "No associated PR found for issue #$ISSUE_NUMBER"
          fi

      - name: Merge Associated PR (if found)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: env.PR_NUMBER != ''
        run: |
          echo "Merging PR #$PR_NUMBER..."
          gh pr merge "$PR_NUMBER" --squash --delete-branch || echo "PR merge failed!"
          echo "PR #$PR_NUMBER has been merged."

      - name: Comment on Issue about PR Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: env.PR_NUMBER != ''
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          if gh pr view "$PR_NUMBER" --json merged --jq '.merged' | grep -q "true"; then
            COMMENT_BODY="✅ The associated PR #$PR_NUMBER has been merged because the issue was marked as completed."
            gh issue comment "$ISSUE_NUMBER" --body "$COMMENT_BODY"
          else
            echo "❌ PR #$PR_NUMBER was NOT merged. No comment will be added."
          fi
