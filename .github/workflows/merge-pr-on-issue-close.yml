name: "Merge Associated PR on Issue Completion (using gh CLI)"

on:
  issues:
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  merge-associated-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Determine Associated PR Number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          BRANCH_NAME="submission/issue-${ISSUE_NUMBER}"
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' || echo "")

          if [[ -n "$PR_NUMBER" ]]; then
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          else
            echo "No associated PR found for issue #$ISSUE_NUMBER"
          fi

      - name: Check if issue was closed as completed
        if: env.PR_NUMBER != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          STATE_REASON=$(gh issue view "$ISSUE_NUMBER" --json stateReason --jq '.stateReason')
          echo "Issue #$ISSUE_NUMBER was closed with reason: $STATE_REASON"

          if [[ "$STATE_REASON" == "COMPLETED" ]]; then
            echo "ISSUE_COMPLETED=true" >> $GITHUB_ENV
          else
            echo "ISSUE_COMPLETED=false" >> $GITHUB_ENV
          fi

      - name: Merge PR if issue was completed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: env.PR_NUMBER != '' && env.ISSUE_COMPLETED == 'true'
        run: |
          echo "Merging PR #$PR_NUMBER..."
          if gh pr merge "$PR_NUMBER" --squash --delete-branch; then
            echo "PR #$PR_NUMBER merged successfully. Triggering clone-repos workflow..."
            gh workflow run clone-repos.yml --ref main
          else
            echo "‚ùå PR merge failed!"
          fi
        

      - name: Close PR if issue was not completed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: env.PR_NUMBER != '' && env.ISSUE_COMPLETED == 'false'
        run: |
          echo "Issue was not completed. Closing PR #$PR_NUMBER without merging..."
          gh pr close "$PR_NUMBER" --delete-branch || echo "PR closing failed!"
          echo "PR #$PR_NUMBER has been closed."


      - name: Comment on Issue about PR action
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: env.PR_NUMBER != ''
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          if [[ "$ISSUE_COMPLETED" == "true" ]]; then
            if [[ -n "$(gh pr view "$PR_NUMBER" --json mergedAt --jq '.mergedAt')" ]]; then
              COMMENT_BODY="‚úÖ The associated PR #$PR_NUMBER has been merged because the issue was marked as completed."
            else
              COMMENT_BODY="‚ö†Ô∏è The associated PR #$PR_NUMBER could not be merged even though the issue was marked as completed."
            fi
          else
            COMMENT_BODY="üîí The associated PR #$PR_NUMBER has been closed without merging because the issue was not completed."
          fi
          gh issue comment "$ISSUE_NUMBER" --body "$COMMENT_BODY"
