name: PR Deadline Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-deadline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check submission time against deadline
        id: deadline-check
        run: |
          # March 6, 2025, 19:00 Indian time (UTC+5:30) = 13:30 UTC
          DEADLINE="2025-04-06T13:30:00Z"
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Current time: $CURRENT_TIME"
          echo "Deadline: $DEADLINE"

          if [[ "$CURRENT_TIME" > "$DEADLINE" ]]; then
            echo "IS_LATE=true" >> $GITHUB_ENV
            echo "submission_status=âš ï¸ **LATE SUBMISSION:** This PR was submitted after the deadline (March 6, 2025, 19:00 Indian time)!" >> $GITHUB_OUTPUT
          else
            echo "IS_LATE=false" >> $GITHUB_ENV
            echo "submission_status=âœ… **ON TIME:** This PR was received before the deadline (March 6, 2025, 19:00 Indian time)." >> $GITHUB_OUTPUT
          fi

      - name: Validate submissions.json
        id: validate-submissions
        run: |
          python -c '
          import json
          import sys

          try:
              with open("submissions.json", "r") as f:
                  submissions = json.load(f)
              
              for submission in submissions:
                  if not all(key in submission for key in ["name", "project_name", "repository_url", "description"]):
                      print("Invalid submission found")
                      sys.exit(1)
          except Exception as e:
              print(f"Error reading submissions.json: {e}")
              sys.exit(1)
          '
        continue-on-error: true

      - name: Determine overall status
        id: overall-status
        run: |
          if [[ "$IS_LATE" == "true" && "${{ steps.validate-submissions.outcome }}" != "success" ]]; then
            echo "comment_body=âš ï¸ **LATE SUBMISSION** and **INVALID submissions.json**: Your submission was late and has missing or incorrect information. Please check and update the PR accordingly." >> $GITHUB_ENV
            echo "labels=late-submission,insufficient-information" >> $GITHUB_ENV
          elif [[ "$IS_LATE" == "true" ]]; then
            echo "comment_body=âš ï¸ **LATE SUBMISSION**: Your PR was submitted after the deadline. It has been marked as late." >> $GITHUB_ENV
            echo "labels=late-submission" >> $GITHUB_ENV
          elif [[ "${{ steps.validate-submissions.outcome }}" != "success" ]]; then
            echo "comment_body=âš ï¸ **INVALID submissions.json**: Your submission is missing required fields. Please ensure `name`, `project_name`, `repository_url`, and `description` are present." >> $GITHUB_ENV
            echo "labels=insufficient-information" >> $GITHUB_ENV
          else
            echo "comment_body=âœ… **All checks passed!** Your submission is on time and correctly formatted. Good job! ðŸŽ‰" >> $GITHUB_ENV
            echo "labels=" >> $GITHUB_ENV
          fi

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ env.comment_body }}

      - name: Add labels if necessary
        if: env.labels != ''
        uses: actions/github-script@v6
        with:
          script: |
            const labelsToAdd = "${{ env.labels }}".split(",");
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labelsToAdd
              });
              console.log("Successfully added labels: " + labelsToAdd.join(", "));
            } catch (error) {
              console.log("Could not add labels: " + error.message);
            }
