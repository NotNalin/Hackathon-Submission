on:
  pull_request:
    types: [opened, synchronize, reopened]
  repository_dispatch:
    types: [pr-validation]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Number"
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-deadline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get PR Number
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          CLIENT_PR_NUMBER="${{ github.event.client_payload.pr_number }}"
          INPUT_PR_NUMBER="${{ github.event.inputs.pr_number }}"

          if [[ -n "$PR_NUMBER" ]]; then
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          elif [[ -n "$CLIENT_PR_NUMBER" ]]; then
            echo "PR_NUMBER=$CLIENT_PR_NUMBER" >> $GITHUB_ENV
          elif [[ -n "$INPUT_PR_NUMBER" ]]; then
            echo "PR_NUMBER=$INPUT_PR_NUMBER" >> $GITHUB_ENV
          else
            echo "❌ PR Number not found!"
            exit 1
          fi

      - name: Check if PR is Late
        id: deadline-check
        run: |
          DEADLINE="2025-02-02T13:30:00Z"
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [[ "$CURRENT_TIME" > "$DEADLINE" ]]; then
            echo "IS_LATE=true" >> $GITHUB_ENV
          else
            echo "IS_LATE=false" >> $GITHUB_ENV
          fi

      - name: Validate submissions.json
        id: validate-submissions
        run: |
          if [ ! -f "submissions.json" ]; then
            echo "VALIDATION_SKIPPED=true" >> $GITHUB_ENV
            exit 0
          fi

          python -c '
          import json
          import sys
          try:
              with open("submissions.json", "r") as f:
                  submissions = json.load(f)
              required_keys = ["name", "project_name", "repository_url", "description"]
              for submission in submissions:
                  if not all(k in submission for k in required_keys):
                      print("❌ Invalid submission format")
                      sys.exit(1)
              print("✅ Valid submissions.json")
          except Exception as e:
              print(f"❌ Error reading file: {e}")
              sys.exit(1)
          '
        continue-on-error: true

      - name: Mark PR as Late
        if: env.IS_LATE == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ env.PR_NUMBER }}
          OLD_TITLE=$(gh api -X GET repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/pulls/$PR_NUMBER --jq .title)
          if [[ ! "$OLD_TITLE" =~ ^\[LATE\] ]]; then
            gh pr edit $PR_NUMBER --title "[LATE] $OLD_TITLE"
          fi

      - name: Add Labels and Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ env.PR_NUMBER }}
          COMMENT=""
          LABELS=""

          if [[ "$IS_LATE" == "true" && "${{ steps.validate-submissions.outcome }}" != "success" ]]; then
            COMMENT="⚠️ **LATE & INVALID submission**. Please fix issues."
            LABELS="late-submission,insufficient-information"
          elif [[ "$IS_LATE" == "true" ]]; then
            COMMENT="⚠️ **LATE submission**. This PR was submitted after the deadline."
            LABELS="late-submission"
          elif [[ "${{ steps.validate-submissions.outcome }}" != "success" ]]; then
            COMMENT="⚠️ **INVALID submissions.json**. Please fix formatting issues."
            LABELS="insufficient-information"
          else
            COMMENT="✅ **All checks passed!** Submission is valid and on time."
          fi

          gh pr comment $PR_NUMBER --body "$COMMENT"

          if [[ -n "$LABELS" ]]; then
            gh issue edit $PR_NUMBER --add-label "$LABELS"
          fi
